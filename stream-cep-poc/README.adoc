= POC on Streaming & CEP with Strimzi and BRMS
:toc:

== Configure OCP Cluster Environment & KAFKA Cluster

Read instructions for 

* * link:https://github.com/skoussou/streaming-cep/blob/master/README-Setup-KAFKA-Cluster.adoc[Ephemeral - KAFKA Cluster Setup]
* link:https://github.com/skoussou/streaming-cep/blob/master/README-Setup-Persistent-KAFKA-Cluster.adoc[Persistent - KAFKA Cluster Setup]



== Deploy the applications

=== To point an application to the correct cluster

[source,sh]
----
    spec:
      containers:
        - name: stream-app
          image: strimzilab/stream-app:latest
          env:
            - name: BOOTSTRAP_SERVERS
              value: "my-cluster-kafka-bootstrap:9092"
----

### FOR THE DEMONSTRATION AT RHTE 2018 we need
a) Use the *strimzi-persistent* template
b) Further tune KAFKA
c) Create topics (see below) which are relevant to our application


=== Create topics

This demo uses a couple of topics. The first one named `iot-temperature` is used by the device simulator for sending 
temperature values and by the stream application for getting such values and processing them. The second one is the 
`iot-temperature-max` topic where the stream application puts the max temperature value processed in the specified time 
window.
In order to create these topics in the Kafka cluster, the Topic Controller can be used. Running the following command, a 
file containing two topic ConfigMaps is deployed to the OpenShift cluster and used by the Topic Controller for creating 
such topics.

[source,sh]
----
oc create -f ./stream-app/resources/topics.yml
----

![topics](images/topics.png)

In order to check that the topics are properly created on the Kafka cluster, it's possible to use the `kafka-topics.sh` script 
(distributed with Kafka) running it on one of the broker.

[source,sh]
----
oc rsh my-cluster-kafka-0
/opt/kafkabin/kafka-topics.sh --zookeeper my-cluster-zookeeper:2181[0 this can be also 1, 2 or whichever zookeeper pod rsh in] --list
----

- name: BOOTSTRAP_SERVERS
              value: "my-cluster-kafka-bootstrap:9092"

The output of the above command should be something like the following showing the created topics.

[source,sh]
----
iot-temperature
iot-temperature-max
----

## Deploy the consumer application

The consumer application uses Kafka client in order to get messages from the `iot-temperature-max` topic and showing them 
in a Web UI.
It's deployed running following command :

[source,sh]
----
oc create -f ./consumer-app/resources/consumer-app.yml
----

A route is provided in order to access the related Web UI.

![route](images/route.png)

![web ui](images/web_ui.png)

## Deploy the stream application

The stream application uses Kafka Streams API reading from the `iot-temperature` topic, processing its values and then 
putting the max temperature value in the specified time window into the `iot-temperature-max` topic.
It's deployed running following command :

[source,sh]
----
oc create -f ./stream-app/resources/stream-app.yml
----

## Deploy the device application

The device application provides a device simulator which sends temperature values to the `iot-temperature` topic.

[source,sh]
----
oc create -f ./device-app/resources/device-app.yml
----

Once deployed, it starts just one pod simulating one device.

![one device gauge](images/one_device_gauge.png)

it's possible to scale up the number of pods in order to simulate more devices sending temperature values (each one with 
a different and randomly generated id).

![scale up device](images/scale_up_device.png)

Opening the consumer Web UI it's possible to see the "gauges" charts showing the processed max temperature values for all the 
active devices on the left side. The right side is useful to see the log of the incoming messages from devices, showing the 
device id alongside the max temperature value processed by the stream application for such a device.

![more device gauges](images/more_device_gauges.png)

## Clean up

If you want it could be useful to clean up the current deployment deleting all the related resources in terms of Pods, Services, Routes and Deployments.

[source,sh]
----
oc delete all -l app=iot-demo
----

And finally the topic config maps

[source,sh]
----
oc delete cm -l strimzi.io/kind=topic
----





